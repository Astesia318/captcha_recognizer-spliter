# 基于单字符识别进行分割的多字符验证码识别

## 开发环境

本项目主要使用python的tensorflow框架，具体包含的第三方库文件如下：

```
python==3.8.0
tensorflow-gpu==2.10.0
keras==2.10.0
pillow==10.2.0
captcha==0.7.1
opencv-python==4.11.0.86
numpy==1.24.3
```

## 项目简介

本项目首先使用captcha库自动生成带标签的单字符数据集，并使用该数据集预训练出一个字符识别器（recognizer），用于多字符（本项目中以四字符为例）验证码的分割和识别。

## 预训练

### 特征提取

其代码实现在该目录下的train_recognizer.py文件下。该项目处理的难题在于如何将单字符上的识别器作用于多字符的应用场景中，同时尽可能地减少代价，在实验和理论分析之后发现，resnet50在迁移学习上展现出了非常好的特征提取能力，于是我们采取resnet50作为单字符识别器（recognizer）。

### 数据集生成

由于本项目的基本实现思路是使用recognizer识别出单字符，进而进行分割，为了避免过程中的“错误识别”现象，即recognizer将完整字符的一部分错认为其它字符，在数据集的生成中，除了正常character_set（letters+digits）之外，添加了一些空白数据，即模型除了可以**判别该字符是什么**之外，还具有了**判别该区域内是否为字符**的能力。

## 基于识别的分割方法

在得到预训练的recognizer之后，将其使用于4字符验证码的分割任务上。分割的基本流程如下：

1. 对图像进行预处理，包括去噪、生成灰度图，二值化；
2. 根据预处理后的图像计算其垂直投影的密度；
3. 设定阈值，得到分割点的集合，使得分割的每部分为“山峰状”，认为其中包含若干字符；
4. 若得到的集合数大于4个，则存在噪声干扰的情况，依次去除分割区间最短的分割点以消除噪声；
5. 若得到的集合数等于4个，则直接依次对每一部分进行识别，得到结果；
6. 若得到的集合数小于4个，则存在字符粘连的情况，通过分类讨论和宽度预估的方法判断其中字符粘连的个数；
7. 对于区间内含有至少两个粘连字符的情况，将区间分割为若干小区间；
8. 对于每个小区间，通过调整区间范围的方法进行多次识别，取得其中后验概率最大的区间作为结果；
9. 以该区间尾作为下一区间头，重复第8步。

## 运行方法

```
python ./train_recognizer.py
python ./main.py
```

## Others

关于图像的尺寸问题，在预训练时单字符的验证码使用50×50×3，4字符的验证码使用50×200×3；

对验证码进行分割后，其大小往往不符合预训练模型的输入形状（50×50×3），因此需要对分割后的图像进行调整，大于输入形状的则将其裁剪，小于输入形状的则将其填充。**注意不能使用拉伸压缩的方法改变图像的原比例**

